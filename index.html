<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bete-Saida Pharmacy | Stock Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* All CSS styles remain exactly the same */
        :root {
            --primary-blue: #0a1f3d;
            --dark-blue: #061224;
            --medium-blue: #1a3a6c;
            --light-blue: #2d5aa0;
            --accent-blue: #3a7bd5;
            --gold: #ffd700;
            --light-gold: #fff8dc;
            --dark-gold: #b8860b;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
            --gray: #8da0c7;
            --light: #e6f0ff;
            --flash-green: #00ff00;
            --flash-dark-green: #00cc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
        }

        /* ... ALL CSS STYLES REMAIN EXACTLY THE SAME AS IN YOUR ORIGINAL CODE ... */

        .conversion-info {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.3rem;
        }
    </style>
</head>
<body>
    <!-- ALL HTML STRUCTURE REMAINS EXACTLY THE SAME -->
    <div class="welcome-page" id="welcomePage">
        <button class="fullscreen-toggle" id="fullscreenToggle">
            <i class="fas fa-expand"></i>
        </button>
        <div class="welcome-content">
            <h1 class="welcome-title">Bete-Saida Pharmacy Stock Management</h1>
            <div class="welcome-owner">Esubalew Biyazin</div>
            
            <div class="login-form" id="loginForm">
                <div class="login-input-group">
                    <label for="loginType"><i class="fas fa-user-tag"></i> Login Type</label>
                    <select id="loginType" required>
                        <option value="">Select login type...</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="login-input-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" required placeholder="Enter password...">
                </div>
                
                <div class="login-buttons">
                    <button class="login-btn" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="particles" id="particles"></div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="container" id="mainContainer">
        <!-- ... ALL HTML PAGES REMAIN EXACTLY THE SAME ... -->
        
        <!-- Register Stock Page -->
        <div class="full-screen-mode" id="registerStockPage">
            <!-- ... ALL REGISTER STOCK PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Sales Page -->
        <div class="full-screen-mode" id="salesPage">
            <!-- ... ALL SALES PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Stock Inventory Page -->
        <div class="full-screen-mode" id="stockInventoryPage">
            <!-- ... ALL INVENTORY PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Add Stock Page -->
        <div class="full-screen-mode" id="addStockPage">
            <!-- ... ALL ADD STOCK PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Deduct Stock Page -->
        <div class="full-screen-mode" id="deductStockPage">
            <!-- ... ALL DEDUCT STOCK PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Review Dashboard Page -->
        <div class="full-screen-mode" id="reviewPage">
            <!-- ... ALL REVIEW PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Audit Trail Page -->
        <div class="full-screen-mode" id="auditPage">
            <!-- ... ALL AUDIT PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Reports & Export Page -->
        <div class="full-screen-mode" id="reportsPage">
            <!-- ... ALL REPORTS PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Data Management Page -->
        <div class="full-screen-mode" id="dataManagementPage">
            <!-- ... ALL DATA MANAGEMENT PAGE HTML REMAINS THE SAME ... -->
        </div>

        <!-- Guideline Modal -->
        <div class="guideline-modal" id="guidelineModal">
            <!-- ... ALL GUIDELINE MODAL HTML REMAINS THE SAME ... -->
        </div>

        <!-- Report Preview Modal -->
        <div class="report-preview-modal" id="reportPreviewModal">
            <!-- ... ALL REPORT PREVIEW MODAL HTML REMAINS THE SAME ... -->
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // Production Configuration with your provided environment variables
        const ENV = {
            DEV: {
                SUPABASE_URL: 'https://myyfiatwzzumtzkjmmas.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15eWZpYXR3enp1bXR6a2ptbWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMDg1NDQsImV4cCI6MjA4NTU4NDU0NH0.XcaXw662IvtchInqM3RMKo3SVWXUT42WSDEDoigalDU',
                WS_URL: 'ws://localhost:8000/ws',
                API_URL: 'http://localhost:8000',
                FRONTEND_ORIGIN: window.location.origin
            },
            PROD: {
                SUPABASE_URL: 'https://myyfiatwzzumtzkjmmas.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15eWZpYXR3enp1bXR6a2ptbWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMDg1NDQsImV4cCI6MjA4NTU4NDU0NH0.XcaXw662IvtchInqM3RMKo3SVWXUT42WSDEDoigalDU',
                WS_URL: 'wss://ameng-gogs-esubestockb-60.deno.dev/ws',
                API_URL: 'https://ameng-gogs-esubestockb-60.deno.dev',
                FRONTEND_ORIGIN: window.location.origin
            }
        };

        // Environment detection - updated for GitHub Pages deployment
        const isDevelopment = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' ||
                            window.location.hostname.includes('github.io');
        
        const CONFIG = isDevelopment ? ENV.DEV : ENV.PROD;

        // Initialize Supabase
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            },
            db: {
                schema: 'public'
            },
            realtime: {
                params: {
                    eventsPerSecond: 10
                }
            }
        });

        // WebSocket connection
        let ws = null;
        let wsReconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const WS_RECONNECT_DELAY = 3000;

        class StockSystem {
            constructor() {
                this.stockItems = [];
                this.salesData = [];
                this.transactions = [];
                this.auditTrail = [];
                this.categories = [];
                this.currentId = 1;
                this.salesCounter = 1001;
                this.transactionCounter = 1;
                this.auditCounter = 1;
                this.isEditing = false;
                this.editingId = null;
                this.isLoggedIn = false;
                this.currentUserType = null;
                this.settings = {
                    lowStockThreshold: 20,
                    expiryWarningDays: 60,
                    defaultMarkup: 50.0,
                    defaultVAT: 15.0,
                    overstockAlert: 150,
                    profitMarginAlert: 10,
                    notifyLowStock: true,
                    notifyExpiry: true,
                    notifyOverstock: true,
                    notifyNegativeProfit: true,
                    autoCostCalc: true,
                    autoProfitCalc: true,
                    autoMarginCalc: true
                };
                
                this.init();
            }
            
            async init() {
                this.createParticles();
                await this.loadSettings();
                this.setupEventListeners();
                
                // Auto open without loading delay
                this.autoOpen();
                
                this.setupRealTimeCalculations();
                this.setupAllClickableElements();
                
                // Initialize WebSocket connection
                this.initWebSocket();
                
                // Initialize Supabase realtime subscriptions
                this.initSupabaseRealtime();
            }
            
            initSupabaseRealtime() {
                // Subscribe to stock_items changes
                const stockChannel = supabase
                    .channel('stock-changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'stock_items' }, 
                        (payload) => {
                            this.handleRealtimeUpdate('stock', payload);
                        }
                    )
                    .subscribe();

                // Subscribe to sales changes
                const salesChannel = supabase
                    .channel('sales-changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'sales' }, 
                        (payload) => {
                            this.handleRealtimeUpdate('sales', payload);
                        }
                    )
                    .subscribe();

                // Subscribe to audit trail changes
                const auditChannel = supabase
                    .channel('audit-changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'audit_trail' }, 
                        (payload) => {
                            this.handleRealtimeUpdate('audit', payload);
                        }
                    )
                    .subscribe();
            }

            handleRealtimeUpdate(type, payload) {
                switch(type) {
                    case 'stock':
                        this.handleStockRealtimeUpdate(payload);
                        break;
                    case 'sales':
                        this.handleSalesRealtimeUpdate(payload);
                        break;
                    case 'audit':
                        this.handleAuditRealtimeUpdate(payload);
                        break;
                }
            }

            handleStockRealtimeUpdate(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                const index = this.stockItems.findIndex(item => item.id === newRecord.id);
                
                if (eventType === 'INSERT') {
                    this.stockItems.push(newRecord);
                    this.showToast(`New item added: ${newRecord.name}`, 'success');
                } else if (eventType === 'UPDATE') {
                    if (index !== -1) {
                        this.stockItems[index] = newRecord;
                        this.showToast(`Item updated: ${newRecord.name}`, 'info');
                    }
                } else if (eventType === 'DELETE') {
                    if (index !== -1) {
                        this.stockItems.splice(index, 1);
                        this.showToast(`Item deleted: ${oldRecord.name}`, 'warning');
                    }
                }

                // Update UI if on relevant pages
                if (document.getElementById('stockInventoryPage').classList.contains('active')) {
                    this.renderTable();
                }
                if (document.getElementById('reviewPage').classList.contains('active')) {
                    this.updateReviewDashboard();
                }
            }

            handleSalesRealtimeUpdate(payload) {
                const { eventType, new: newRecord } = payload;
                
                if (eventType === 'INSERT') {
                    this.salesData.push(newRecord);
                    this.showToast(`New sale recorded: ${newRecord.invoice_number}`, 'success');
                }
                
                // Update dashboard if needed
                if (document.getElementById('reviewPage').classList.contains('active')) {
                    this.updateReviewDashboard();
                }
            }

            handleAuditRealtimeUpdate(payload) {
                const { eventType, new: newRecord } = payload;
                
                if (eventType === 'INSERT') {
                    this.auditTrail.push(newRecord);
                    // Update audit page if active
                    if (document.getElementById('auditPage').classList.contains('active')) {
                        this.updateAuditSummary();
                        this.runAuditReport();
                    }
                }
            }
            
            autoOpen() {
                // Show welcome page immediately without loading delay
                document.getElementById('welcomePage').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }
            
            initWebSocket() {
                this.connectWebSocket();
                
                // Set up reconnection
                setInterval(() => {
                    if (!ws || ws.readyState === WebSocket.CLOSED) {
                        this.connectWebSocket();
                    }
                }, WS_RECONNECT_DELAY);
            }
            
            connectWebSocket() {
                if (wsReconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                    console.warn('Max WebSocket reconnection attempts reached');
                    return;
                }
                
                try {
                    ws = new WebSocket(CONFIG.WS_URL);
                    
                    ws.onopen = () => {
                        console.log('WebSocket connected to:', CONFIG.WS_URL);
                        wsReconnectAttempts = 0;
                        
                        // Send authentication if logged in
                        if (this.isLoggedIn) {
                            this.sendWebSocketMessage({
                                type: 'auth',
                                userType: this.currentUserType,
                                timestamp: new Date().toISOString()
                            });
                        }
                    };
                    
                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleWebSocketMessage(message);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                    
                    ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        wsReconnectAttempts++;
                        
                        // Attempt reconnection
                        setTimeout(() => this.connectWebSocket(), WS_RECONNECT_DELAY);
                    };
                } catch (error) {
                    console.error('WebSocket connection error:', error);
                }
            }
            
            sendWebSocketMessage(message) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(message));
                }
            }
            
            handleWebSocketMessage(message) {
                switch (message.type) {
                    case 'stock_update':
                        this.handleStockUpdate(message.data);
                        break;
                    case 'sale_update':
                        this.handleSaleUpdate(message.data);
                        break;
                    case 'audit_update':
                        this.handleAuditUpdate(message.data);
                        break;
                    case 'sync_request':
                        this.handleSyncRequest();
                        break;
                    case 'notification':
                        this.showToast(message.data.message, message.data.type || 'info');
                        break;
                    case 'pong':
                        // Keep-alive response
                        break;
                    default:
                        console.log('Unknown WebSocket message type:', message.type);
                }
            }
            
            handleStockUpdate(update) {
                const index = this.stockItems.findIndex(item => item.id === update.id);
                if (index !== -1) {
                    this.stockItems[index] = update;
                } else {
                    this.stockItems.push(update);
                }
                
                // Update UI if on stock page
                if (document.getElementById('stockInventoryPage').classList.contains('active')) {
                    this.renderTable();
                }
                
                // Update review dashboard if active
                if (document.getElementById('reviewPage').classList.contains('active')) {
                    this.updateReviewDashboard();
                }
                
                this.showToast('Stock updated in real-time', 'info');
            }
            
            handleSaleUpdate(sale) {
                const index = this.salesData.findIndex(s => s.id === sale.id);
                if (index !== -1) {
                    this.salesData[index] = sale;
                } else {
                    this.salesData.push(sale);
                }
                
                // Update dashboard if active
                if (document.getElementById('reviewPage').classList.contains('active')) {
                    this.updateReviewDashboard();
                }
            }
            
            handleAuditUpdate(audit) {
                const index = this.auditTrail.findIndex(a => a.id === audit.id);
                if (index !== -1) {
                    this.auditTrail[index] = audit;
                } else {
                    this.auditTrail.push(audit);
                }
                
                // Update audit page if active
                if (document.getElementById('auditPage').classList.contains('active')) {
                    this.updateAuditSummary();
                    this.runAuditReport();
                }
            }
            
            handleSyncRequest() {
                // Send current data to sync
                this.sendWebSocketMessage({
                    type: 'sync_data',
                    data: {
                        stockItems: this.stockItems,
                        salesData: this.salesData,
                        auditTrail: this.auditTrail,
                        timestamp: new Date().toISOString()
                    }
                });
            }
            
            async loadSettings() {
                try {
                    // Try to load from Supabase first
                    const { data, error } = await supabase
                        .from('settings')
                        .select('*')
                        .eq('key', 'pharmacy_settings')
                        .single();
                    
                    if (!error && data) {
                        this.settings = { ...this.settings, ...data.value };
                    }
                    
                    // Load categories
                    await this.loadCategories();
                    
                    // Load stock items
                    await this.loadStockItems();
                    
                    // Load sales data
                    await this.loadSalesData();
                    
                    // Load audit trail
                    await this.loadAuditTrail();
                    
                } catch (error) {
                    console.log('Using default settings:', error);
                }
            }
            
            async loadStockItems() {
                try {
                    const { data, error } = await supabase
                        .from('stock_items')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!error && data) {
                        this.stockItems = data;
                    }
                } catch (error) {
                    console.error('Error loading stock items:', error);
                }
            }
            
            async loadSalesData() {
                try {
                    const { data, error } = await supabase
                        .from('sales')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100);
                    
                    if (!error && data) {
                        this.salesData = data;
                    }
                } catch (error) {
                    console.error('Error loading sales data:', error);
                }
            }
            
            async loadAuditTrail() {
                try {
                    const { data, error } = await supabase
                        .from('audit_trail')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100);
                    
                    if (!error && data) {
                        this.auditTrail = data;
                    }
                } catch (error) {
                    console.error('Error loading audit trail:', error);
                }
            }
            
            async loadCategories() {
                try {
                    const { data, error } = await supabase
                        .from('categories')
                        .select('*')
                        .order('name');
                    
                    if (!error && data) {
                        this.categories = data.map(c => c.name);
                    } else {
                        // Use default categories
                        this.categories = this.getDefaultCategories();
                    }
                    
                    // Update category lists
                    this.updateCategoryLists();
                } catch (error) {
                    this.categories = this.getDefaultCategories();
                    this.updateCategoryLists();
                }
            }
            
            getDefaultCategories() {
                return [
                    "Analgesics / Painkillers",
                    "Anesthetics",
                    "Antacids",
                    "Anthelmintics",
                    "Anti-addiction / Withdrawal Drugs",
                    "Anti-anginal Drugs",
                    "Anti-anxiety Agents",
                    "Anti-arrhythmic Drugs",
                    "Antibiotics / Antimicrobials",
                    "Anticholinergic Drugs",
                    "Anticoagulants / Antiplatelets",
                    "Anticonvulsants / Antiepileptics",
                    "Antidepressants / Psychotropics",
                    "Anti-diarrheal Agents",
                    "Antidiabetics",
                    "Antiemetics",
                    "Antifibrotic Agents",
                    "Antifungals",
                    "Anti-gout Agents",
                    "Antihistamines",
                    "Antihypertensives",
                    "Antihyperlipidemic / Lipid-lowering Drugs",
                    "Anti-inflammatory Drugs / NSAIDs",
                    "Anti-malarials",
                    "Anti-migraine Agents",
                    "Anti-obesity Drugs",
                    "Anti-Parkinson Drugs",
                    "Antipyretics",
                    "Anti-psychotics",
                    "Antiseptics / Disinfectants",
                    "Anti-spasmodic",
                    "Anti-thyroid Drugs",
                    "Anti-ulcer Agents / Proton Pump Inhibitors",
                    "Antivirals",
                    "Anti-viral Topical Agents",
                    "Bone / Calcium Preparations",
                    "Cardiovascular Drugs",
                    "Cardiotonic / Heart Failure Drugs",
                    "Chemoprotective Agents",
                    "Chemotherapeutic Agents / Antineoplastics",
                    "Cholinergic Drugs",
                    "Cold & Flu Preparations",
                    "Contraceptives",
                    "Dermatological Antibiotics",
                    "Diagnostic Agents / Contrast Media",
                    "Diuretics",
                    "Electrolytes / Mineral Supplements",
                    "Enzyme Preparations",
                    "Gastrointestinal Drugs",
                    "Growth Hormones",
                    "Hematological Agents / Blood Products",
                    "Hemostatic Agents",
                    "Hormones / Endocrine Drugs",
                    "Immunologicals / Vaccines",
                    "Immunosuppressants",
                    "Laxatives / Stool Softeners",
                    "Muscle Relaxants",
                    "Nasal Preparations",
                    "Ophthalmic Anti-infectives",
                    "Ophthalmic Lubricants",
                    "Ophthalmic Preparations",
                    "Oral Contraceptives / Reproductive Drugs",
                    "Otic / Ear Preparations",
                    "Peripheral Vasodilators",
                    "Respiratory Allergens / Antihistamines",
                    "Respiratory Drugs / Bronchodilators",
                    "Sedatives / Hypnotics",
                    "Skin Protectants / Emollients",
                    "Smoking Cessation Aids",
                    "Thrombolytics",
                    "Topical Agents / Dermatologicals",
                    "Topical Antiviral",
                    "Topical Corticosteroids",
                    "Vaccines",
                    "Vaccines – Inactivated",
                    "Vaccines – Live",
                    "Vitamins / Supplements"
                ].sort();
            }
            
            updateCategoryLists() {
                const categoryList = document.getElementById('categoryList');
                if (categoryList) {
                    categoryList.innerHTML = this.categories
                        .map(cat => `<option value="${cat}">`)
                        .join('');
                }
                
                // Update category filter
                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    const currentValue = categoryFilter.value;
                    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                        this.categories.map(cat => 
                            `<option value="${cat}" ${cat === currentValue ? 'selected' : ''}>${cat}</option>`
                        ).join('');
                }
                
                // Update report category filter
                const reportCategory = document.getElementById('reportCategory');
                if (reportCategory) {
                    reportCategory.innerHTML = '<option value="">All Categories</option>' +
                        this.categories.map(cat => 
                            `<option value="${cat}">${cat}</option>`
                        ).join('');
                }
            }
            
            async saveToSupabase(table, data) {
                try {
                    // If data has an id, it's an update, otherwise insert
                    const { error } = data.id 
                        ? await supabase.from(table).upsert(data)
                        : await supabase.from(table).insert([data]);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error(`Error saving to ${table}:`, error);
                    
                    // Show user-friendly error message
                    if (error.message.includes('JWT')) {
                        this.showToast('Authentication error. Please login again.', 'danger');
                    } else if (error.message.includes('permission')) {
                        this.showToast('Permission denied. Check RLS policies.', 'danger');
                    } else if (error.message.includes('network')) {
                        this.showToast('Network error. Please check connection.', 'danger');
                    } else {
                        this.showToast(`Error saving to ${table}: ${error.message}`, 'danger');
                    }
                    
                    return false;
                }
            }
            
            async saveItem() {
                try {
                    const registeredToBaseFactor = parseFloat(document.getElementById('registeredToBaseFactor').value) || 1;
                    const displayToBaseFactor = parseFloat(document.getElementById('displayToBaseFactor').value) || 1;
                    const quantityType = document.getElementById('initialQuantityType').value;
                    const quantity = parseFloat(document.getElementById('initialQuantity').value) || 0;
                    
                    if (registeredToBaseFactor <= 0 || displayToBaseFactor <= 0) {
                        this.showToast('Conversion factors must be greater than 0', 'warning');
                        return;
                    }
                    
                    let baseQuantity = 0;
                    switch(quantityType) {
                        case 'registered':
                            baseQuantity = quantity * registeredToBaseFactor;
                            break;
                        case 'display':
                            baseQuantity = quantity * displayToBaseFactor;
                            break;
                        case 'base':
                            baseQuantity = quantity;
                            break;
                    }
                    
                    const itemData = {
                        id: this.isEditing ? this.editingId : crypto.randomUUID(),
                        name: document.getElementById('itemName').value.trim(),
                        category: document.getElementById('category').value,
                        base_unit: document.getElementById('baseUnit').value,
                        registered_unit: document.getElementById('registeredUnit').value.trim(),
                        registered_to_base_factor: registeredToBaseFactor,
                        display_unit: document.getElementById('displayUnit').value.trim(),
                        display_to_base_factor: displayToBaseFactor,
                        allow_fractional_display: document.getElementById('allowFractionalDisplay').value === 'true',
                        quantity_base: baseQuantity,
                        purchase_price_per_display: parseFloat(document.getElementById('purchasePricePerDisplay').value) || 0,
                        markup: parseFloat(document.getElementById('markup').value) || 0,
                        selling_price_per_display: parseFloat(document.getElementById('sellingPricePerDisplay').value) || 0,
                        batch_number: document.getElementById('batchNumber').value.trim(),
                        expiry_date: document.getElementById('expiryDate').value,
                        supplier: document.getElementById('supplier').value.trim(),
                        registrant: document.getElementById('registrant').value.trim(),
                        branch: document.getElementById('branch').value,
                        storage_location: document.getElementById('storageLocation').value.trim(),
                        min_stock_base: parseInt(document.getElementById('minStockBase').value) || 10,
                        max_stock_base: parseInt(document.getElementById('maxStockBase').value) || 100,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Validation
                    if (!itemData.name || !itemData.category || !itemData.base_unit || 
                        !itemData.registered_unit || !itemData.display_unit || 
                        baseQuantity < 0 || !itemData.batch_number || !itemData.supplier || 
                        !itemData.registrant) {
                        this.showToast('Please fill all required fields correctly', 'warning');
                        return;
                    }
                    
                    // Validate expiry date
                    if (new Date(itemData.expiry_date) < new Date()) {
                        this.showToast('Expiry date cannot be in the past', 'warning');
                        return;
                    }
                    
                    // Save to Supabase
                    const success = await this.saveToSupabase('stock_items', itemData);
                    if (!success) {
                        this.showToast('Error saving item to database', 'danger');
                        return;
                    }
                    
                    // Update local state
                    if (this.isEditing) {
                        const index = this.stockItems.findIndex(i => i.id === itemData.id);
                        if (index !== -1) {
                            this.stockItems[index] = itemData;
                        }
                        this.recordAudit('edit', itemData.id, itemData.name, itemData.quantity_base, 
                                       'item_updated', itemData.branch, itemData.registrant);
                        this.showToast('Item updated successfully!', 'success');
                    } else {
                        this.stockItems.push(itemData);
                        this.recordTransaction('addition', itemData.id, itemData.name, itemData.quantity_base, 
                                              'new_item', itemData.branch, itemData.purchase_price_per_display, 
                                              itemData.registrant, itemData.display_unit);
                        this.recordAudit('create', itemData.id, itemData.name, itemData.quantity_base, 
                                       'item_registered', itemData.branch, itemData.registrant);
                        this.showToast('Item registered successfully!', 'success');
                    }
                    
                    // Send WebSocket update
                    this.sendWebSocketMessage({
                        type: 'stock_update',
                        data: itemData
                    });
                    
                    this.clearForm();
                    this.isEditing = false;
                    this.editingId = null;
                    
                } catch (error) {
                    console.error('Error saving item:', error);
                    this.showToast('Error saving item: ' + error.message, 'danger');
                }
            }
            
            async processSale() {
                try {
                    const items = [];
                    let isValid = true;
                    
                    document.querySelectorAll('#salesItemsBody tr').forEach(row => {
                        const searchInput = row.querySelector('.sales-item-search');
                        const quantityInput = row.querySelector('.sales-quantity');
                        
                        if (!searchInput.value || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                            isValid = false;
                            return;
                        }
                        
                        const stockItem = this.stockItems.find(item => 
                            item.name.toLowerCase() === searchInput.value.trim().toLowerCase()
                        );
                        
                        if (!stockItem) {
                            isValid = false;
                            this.showToast(`Item not found: ${searchInput.value}`, 'warning');
                            return;
                        }
                        
                        const quantity = parseFloat(quantityInput.value);
                        const maxDisplayQuantity = stockItem.quantity_base / stockItem.display_to_base_factor;
                        
                        if (quantity > maxDisplayQuantity) {
                            isValid = false;
                            this.showToast(`Insufficient stock for ${stockItem.name}. Available: ${maxDisplayQuantity.toFixed(2)} ${stockItem.display_unit}`, 'warning');
                            return;
                        }
                        
                        const baseQuantity = quantity * stockItem.display_to_base_factor;
                        const unitPrice = parseFloat(row.querySelector('.sales-unit-price').value) || stockItem.selling_price_per_display;
                        const discount = parseFloat(row.querySelector('.sales-discount').value) || 0;
                        const vat = parseFloat(row.querySelector('.sales-vat').value) || this.settings.defaultVAT;
                        const subtotal = quantity * unitPrice;
                        const vatAmount = subtotal * (vat / 100);
                        const netAmount = subtotal + vatAmount - discount;
                        const costPerBaseUnit = stockItem.purchase_price_per_display / stockItem.display_to_base_factor;
                        const totalCost = baseQuantity * costPerBaseUnit;
                        
                        items.push({
                            item_id: stockItem.id,
                            name: stockItem.name,
                            batch: row.querySelector('.sales-batch').value || stockItem.batch_number,
                            base_unit: stockItem.base_unit,
                            display_unit: stockItem.display_unit,
                            display_to_base_factor: stockItem.display_to_base_factor,
                            quantity: quantity,
                            quantity_base: baseQuantity,
                            cost_price: costPerBaseUnit,
                            unit_price: unitPrice,
                            discount: discount,
                            vat: vat,
                            subtotal: subtotal,
                            vat_amount: vatAmount,
                            net_amount: netAmount,
                            profit: netAmount - totalCost,
                            margin: costPerBaseUnit > 0 ? ((unitPrice - (costPerBaseUnit * stockItem.display_to_base_factor)) / (costPerBaseUnit * stockItem.display_to_base_factor) * 100) : 0
                        });
                    });
                    
                    if (!isValid || items.length === 0) {
                        this.showToast('Please fill all item details correctly', 'warning');
                        return;
                    }
                    
                    // Calculate totals
                    const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
                    const totalDiscount = items.reduce((sum, item) => sum + item.discount, 0);
                    const totalVAT = items.reduce((sum, item) => sum + item.vat_amount, 0);
                    const grandTotal = subtotal + totalVAT - totalDiscount;
                    const totalCost = items.reduce((sum, item) => sum + (item.quantity_base * item.cost_price), 0);
                    const grossProfit = grandTotal - totalCost;
                    const profitMargin = totalCost > 0 ? (grossProfit / totalCost * 100) : 0;
                    
                    // Generate invoice number
                    const invoiceNumber = `INV-${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${this.salesCounter.toString().padStart(4,'0')}`;
                    
                    // Create sale record
                    const saleRecord = {
                        id: crypto.randomUUID(),
                        invoice_number: invoiceNumber,
                        date: document.getElementById('salesDate').value || new Date().toISOString().split('T')[0],
                        branch: document.getElementById('salesBranch').value,
                        payment_method: document.getElementById('salesPaymentMethod').value,
                        salesperson: document.getElementById('salesperson').value,
                        approver: document.getElementById('salesApprover').value || '',
                        items: items,
                        subtotal: subtotal,
                        discount: totalDiscount,
                        vat: totalVAT,
                        grand_total: grandTotal,
                        cogs: totalCost,
                        gross_profit: grossProfit,
                        profit_margin: profitMargin,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Validate required fields
                    if (!saleRecord.salesperson || !saleRecord.branch) {
                        this.showToast('Please fill all required fields', 'warning');
                        return;
                    }
                    
                    // Save sale to Supabase
                    const saleSuccess = await this.saveToSupabase('sales', saleRecord);
                    if (!saleSuccess) {
                        this.showToast('Error saving sale to database', 'danger');
                        return;
                    }
                    
                    // Update stock quantities and record transactions
                    for (const item of items) {
                        const stockItem = this.stockItems.find(i => i.id === item.item_id);
                        if (stockItem) {
                            stockItem.quantity_base -= item.quantity_base;
                            stockItem.updated_at = new Date().toISOString();
                            
                            // Update stock in Supabase
                            await this.saveToSupabase('stock_items', stockItem);
                            
                            // Send WebSocket update
                            this.sendWebSocketMessage({
                                type: 'stock_update',
                                data: stockItem
                            });
                            
                            this.recordTransaction('deduction', stockItem.id, stockItem.name, item.quantity_base, 
                                                  'sale', saleRecord.branch, item.unit_price, saleRecord.salesperson, item.display_unit);
                            
                            this.recordAudit('sale', stockItem.id, stockItem.name, item.quantity_base, 
                                           'sale_outflow', saleRecord.branch, saleRecord.salesperson, {
                                               invoice: saleRecord.invoice_number,
                                               unitPrice: item.unit_price,
                                               profit: item.profit,
                                               margin: item.margin,
                                               discount: item.discount
                                           });
                        }
                    }
                    
                    this.salesData.push(saleRecord);
                    this.salesCounter++;
                    
                    // Send WebSocket update for sale
                    this.sendWebSocketMessage({
                        type: 'sale_update',
                        data: saleRecord
                    });
                    
                    this.showToast(`Sale saved! Invoice: ${saleRecord.invoice_number}`, 'success');
                    this.clearSalesForm();
                    
                } catch (error) {
                    console.error('Error processing sale:', error);
                    this.showToast('Error processing sale: ' + error.message, 'danger');
                }
            }
            
            async recordAudit(action, itemId, itemName, quantityBase, eventType, branch, user, details = {}) {
                try {
                    const audit = {
                        id: crypto.randomUUID(),
                        action: action,
                        item_id: itemId,
                        item_name: itemName,
                        quantity: quantityBase || 0,
                        event_type: eventType,
                        branch: branch,
                        user: user,
                        details: details,
                        created_at: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toLocaleTimeString(),
                        approval_status: details.approver ? 'Approved' : 'Pending'
                    };
                    
                    // Save to Supabase
                    await this.saveToSupabase('audit_trail', audit);
                    
                    this.auditTrail.push(audit);
                    
                    // Send WebSocket update
                    this.sendWebSocketMessage({
                        type: 'audit_update',
                        data: audit
                    });
                    
                    if (document.getElementById('auditPage').classList.contains('active')) {
                        this.updateAuditSummary();
                    }
                } catch (error) {
                    console.error('Error recording audit:', error);
                }
            }
            
            async recordTransaction(type, itemId, itemName, quantityBase, reason, branch, unitPrice, responsible, unit) {
                try {
                    const transaction = {
                        id: crypto.randomUUID(),
                        type: type,
                        item_id: itemId,
                        item_name: itemName,
                        quantity: quantityBase,
                        unit: unit || '',
                        reason: reason,
                        branch: branch,
                        unit_price: unitPrice || 0,
                        total_value: quantityBase * (unitPrice || 0),
                        responsible: responsible || 'System',
                        created_at: new Date().toISOString()
                    };
                    
                    // Save to Supabase
                    await this.saveToSupabase('transactions', transaction);
                    
                    this.transactions.push(transaction);
                } catch (error) {
                    console.error('Error recording transaction:', error);
                }
            }
            
            createParticles() {
                const particles = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.width = Math.random() * 5 + 2 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = Math.random() * 20 + 10 + 's';
                    particles.appendChild(particle);
                }
            }
            
            setupEventListeners() {
                // Login
                document.getElementById('loginBtn').addEventListener('click', () => this.handleLogin());
                document.getElementById('password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
                
                // Fullscreen toggle
                document.getElementById('fullscreenToggle').addEventListener('click', () => this.toggleFullscreen());
                
                // Navigation buttons
                document.getElementById('navRegisterStock').addEventListener('click', () => this.openPage('registerStockPage'));
                document.getElementById('navSales').addEventListener('click', () => this.openPage('salesPage'));
                document.getElementById('navCurrentStock').addEventListener('click', () => this.openPage('stockInventoryPage'));
                document.getElementById('navAddStock').addEventListener('click', () => this.openPage('addStockPage'));
                document.getElementById('navReduceStock').addEventListener('click', () => this.openPage('deductStockPage'));
                document.getElementById('navReview').addEventListener('click', () => this.openPage('reviewPage'));
                document.getElementById('navAudit').addEventListener('click', () => this.openPage('auditPage'));
                document.getElementById('navReports').addEventListener('click', () => this.openPage('reportsPage'));
                document.getElementById('navDataManagement').addEventListener('click', () => this.openPage('dataManagementPage'));
                
                // Close buttons
                document.getElementById('closeRegisterStock').addEventListener('click', () => this.closePage('registerStockPage'));
                document.getElementById('closeSales').addEventListener('click', () => this.closePage('salesPage'));
                document.getElementById('closeStockInventory').addEventListener('click', () => this.closePage('stockInventoryPage'));
                document.getElementById('closeAddStock').addEventListener('click', () => this.closePage('addStockPage'));
                document.getElementById('closeDeductStock').addEventListener('click', () => this.closePage('deductStockPage'));
                document.getElementById('closeReview').addEventListener('click', () => this.closePage('reviewPage'));
                document.getElementById('closeAudit').addEventListener('click', () => this.closePage('auditPage'));
                document.getElementById('closeReports').addEventListener('click', () => this.closePage('reportsPage'));
                document.getElementById('closeDataManagement').addEventListener('click', () => this.closePage('dataManagementPage'));
                document.getElementById('closeGuideline').addEventListener('click', () => this.closePage('guidelineModal'));
                
                // Form submissions
                document.getElementById('stockForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveItem();
                });
                
                document.getElementById('salesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processSale();
                });
                
                document.getElementById('addStockForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processAddStock();
                });
                
                document.getElementById('reduceStockForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processDeductStock();
                });
                
                // Other buttons
                document.getElementById('guidelineBtn').addEventListener('click', () => this.openPage('guidelineModal'));
                document.getElementById('clearForm').addEventListener('click', () => this.clearForm());
                document.getElementById('clearSalesForm').addEventListener('click', () => this.clearSalesForm());
                document.getElementById('newSalesForm').addEventListener('click', () => this.clearSalesForm(true));
                document.getElementById('addSalesRow').addEventListener('click', () => this.addSalesRow());
                document.getElementById('applyMarkup').addEventListener('click', () => this.applyMarkup());
                
                // Search and filter
                document.getElementById('searchInput').addEventListener('input', () => this.renderTable());
                document.getElementById('categoryFilter').addEventListener('change', () => this.renderTable());
                document.getElementById('branchFilter').addEventListener('change', () => this.renderTable());
                document.getElementById('statusFilter').addEventListener('change', () => this.renderTable());
                document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
                
                // Settings
                document.getElementById('saveSettings').addEventListener('click', () => this.saveSystemSettings());
                
                // Export
                document.getElementById('exportToExcel').addEventListener('click', () => this.exportToExcel());
                
                // Initialize current date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('salesDate').value = today;
                document.getElementById('expiryDate').min = today;
                document.getElementById('addExpiryDate').min = today;
            }
            
            handleLogin() {
                const loginType = document.getElementById('loginType').value;
                const password = document.getElementById('password').value;
                
                // Simple password validation
                if (!loginType || !password) {
                    this.showToast('Please select login type and enter password', 'warning');
                    return;
                }
                
                // For demo purposes - in production, validate against backend
                const validPasswords = {
                    'user': 'user123',
                    'admin': 'admin123'
                };
                
                if (password === validPasswords[loginType]) {
                    this.isLoggedIn = true;
                    this.currentUserType = loginType;
                    
                    // Hide welcome page, show main container
                    document.getElementById('welcomePage').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('welcomePage').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                        
                        // Show/hide admin buttons based on login type
                        const adminButtons = document.querySelectorAll('.admin-nav-btn');
                        adminButtons.forEach(btn => {
                            btn.style.display = loginType === 'admin' ? 'block' : 'none';
                        });
                        
                        this.showToast(`Welcome ${loginType.toUpperCase()}!`, 'success');
                        
                        // Send WebSocket authentication
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            this.sendWebSocketMessage({
                                type: 'auth',
                                userType: loginType,
                                timestamp: new Date().toISOString()
                            });
                        }
                    }, 500);
                } else {
                    this.showToast('Invalid password', 'danger');
                }
            }
            
            openPage(pageId) {
                document.querySelectorAll('.full-screen-mode, .guideline-modal').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
                
                // Load data for specific pages
                switch(pageId) {
                    case 'stockInventoryPage':
                        this.renderTable();
                        break;
                    case 'reviewPage':
                        this.updateReviewDashboard();
                        break;
                    case 'auditPage':
                        this.updateAuditSummary();
                        this.runAuditReport();
                        break;
                    case 'addStockPage':
                        this.populateAddStockItems();
                        break;
                    case 'deductStockPage':
                        this.populateDeductStockItems();
                        break;
                    case 'reportsPage':
                        // Initialize report filters
                        break;
                }
            }
            
            closePage(pageId) {
                document.getElementById(pageId).classList.remove('active');
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
            
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'danger': 'fas fa-times-circle',
                    'info': 'fas fa-info-circle'
                };
                
                toast.innerHTML = `
                    <i class="${icons[type] || icons.info}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 5 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        toastContainer.removeChild(toast);
                    }, 300);
                }, 5000);
            }
            
            clearForm() {
                document.getElementById('stockForm').reset();
                document.getElementById('registeredToBaseFactor').value = 1;
                document.getElementById('displayToBaseFactor').value = 1;
                document.getElementById('initialQuantity').value = '';
                document.getElementById('baseQuantityDisplay').textContent = '0 base units';
                document.getElementById('mixedUnitDisplay').textContent = 'No units registered yet';
                document.getElementById('totalValueCalc').textContent = 'ETB 0.00 (0 base units)';
                this.isEditing = false;
                this.editingId = null;
            }
            
            clearSalesForm() {
                document.getElementById('salesItemsBody').innerHTML = '';
                this.addSalesRow(); // Add one empty row
                this.updateSalesSummary();
            }
            
            addSalesRow() {
                const tbody = document.getElementById('salesItemsBody');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" class="sales-item-search" list="stockItemsList" placeholder="Search item...">
                        <datalist id="stockItemsList">
                            ${this.stockItems.map(item => `<option value="${item.name}">`).join('')}
                        </datalist>
                    </td>
                    <td><input type="text" class="sales-batch" placeholder="Batch"></td>
                    <td class="sales-base-unit"></td>
                    <td class="sales-display-unit"></td>
                    <td><input type="number" class="sales-quantity" min="0.01" step="0.01" placeholder="Qty" value="1"></td>
                    <td class="sales-base-quantity">0</td>
                    <td><input type="number" class="sales-unit-price" min="0" step="0.01" placeholder="Price"></td>
                    <td><input type="number" class="sales-discount" min="0" step="0.01" placeholder="0.00" value="0"></td>
                    <td><input type="number" class="sales-vat" min="0" step="0.1" placeholder="15" value="${this.settings.defaultVAT}"></td>
                    <td class="sales-total">0.00</td>
                    <td><button type="button" class="action-btn remove-row"><i class="fas fa-trash"></i></button></td>
                `;
                
                tbody.appendChild(row);
                
                // Add event listeners
                const searchInput = row.querySelector('.sales-item-search');
                const quantityInput = row.querySelector('.sales-quantity');
                const priceInput = row.querySelector('.sales-unit-price');
                const discountInput = row.querySelector('.sales-discount');
                const vatInput = row.querySelector('.sales-vat');
                const removeBtn = row.querySelector('.remove-row');
                
                searchInput.addEventListener('input', () => this.updateSalesRow(row));
                quantityInput.addEventListener('input', () => this.updateSalesRow(row));
                priceInput.addEventListener('input', () => this.updateSalesRow(row));
                discountInput.addEventListener('input', () => this.updateSalesRow(row));
                vatInput.addEventListener('input', () => this.updateSalesRow(row));
                removeBtn.addEventListener('click', () => row.remove());
            }
            
            updateSalesRow(row) {
                const searchInput = row.querySelector('.sales-item-search');
                const quantityInput = row.querySelector('.sales-quantity');
                const priceInput = row.querySelector('.sales-unit-price');
                const discountInput = row.querySelector('.sales-discount');
                const vatInput = row.querySelector('.sales-vat');
                
                const itemName = searchInput.value.trim();
                const stockItem = this.stockItems.find(item => 
                    item.name.toLowerCase() === itemName.toLowerCase()
                );
                
                if (stockItem) {
                    row.querySelector('.sales-base-unit').textContent = stockItem.base_unit;
                    row.querySelector('.sales-display-unit').textContent = stockItem.display_unit;
                    
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const baseQuantity = quantity * stockItem.display_to_base_factor;
                    row.querySelector('.sales-base-quantity').textContent = baseQuantity.toFixed(2);
                    
                    if (!priceInput.value && stockItem.selling_price_per_display) {
                        priceInput.value = stockItem.selling_price_per_display;
                    }
                    
                    const unitPrice = parseFloat(priceInput.value) || 0;
                    const discount = parseFloat(discountInput.value) || 0;
                    const vat = parseFloat(vatInput.value) || this.settings.defaultVAT;
                    
                    const subtotal = quantity * unitPrice;
                    const vatAmount = subtotal * (vat / 100);
                    const total = subtotal + vatAmount - discount;
                    
                    row.querySelector('.sales-total').textContent = total.toFixed(2);
                }
                
                this.updateSalesSummary();
            }
            
            updateSalesSummary() {
                let subtotal = 0;
                let totalDiscount = 0;
                let totalVAT = 0;
                let totalCost = 0;
                
                document.querySelectorAll('#salesItemsBody tr').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.sales-quantity').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.sales-unit-price').value) || 0;
                    const discount = parseFloat(row.querySelector('.sales-discount').value) || 0;
                    const vat = parseFloat(row.querySelector('.sales-vat').value) || this.settings.defaultVAT;
                    
                    const itemSubtotal = quantity * unitPrice;
                    const itemVAT = itemSubtotal * (vat / 100);
                    
                    subtotal += itemSubtotal;
                    totalDiscount += discount;
                    totalVAT += itemVAT;
                    
                    // Calculate cost (simplified - would need actual cost data)
                    const itemName = row.querySelector('.sales-item-search').value;
                    const stockItem = this.stockItems.find(item => 
                        item.name.toLowerCase() === itemName.toLowerCase()
                    );
                    if (stockItem && stockItem.purchase_price_per_display) {
                        totalCost += quantity * stockItem.purchase_price_per_display;
                    }
                });
                
                const grandTotal = subtotal + totalVAT - totalDiscount;
                const grossProfit = grandTotal - totalCost;
                const profitMargin = totalCost > 0 ? (grossProfit / totalCost * 100) : 0;
                
                document.getElementById('salesSubtotal').textContent = `ETB ${subtotal.toFixed(2)}`;
                document.getElementById('salesTotalDiscount').textContent = `ETB ${totalDiscount.toFixed(2)}`;
                document.getElementById('salesTotalVAT').textContent = `ETB ${totalVAT.toFixed(2)}`;
                document.getElementById('salesGrandTotal').textContent = `ETB ${grandTotal.toFixed(2)}`;
                document.getElementById('salesCOGS').textContent = `ETB ${totalCost.toFixed(2)}`;
                document.getElementById('salesGrossProfit').textContent = `ETB ${grossProfit.toFixed(2)}`;
                document.getElementById('salesProfitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            }
            
            renderTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const branchFilter = document.getElementById('branchFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                let filteredItems = this.stockItems;
                
                // Apply filters
                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.category.toLowerCase().includes(searchTerm) ||
                        item.batch_number.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (categoryFilter) {
                    filteredItems = filteredItems.filter(item => item.category === categoryFilter);
                }
                
                if (branchFilter) {
                    filteredItems = filteredItems.filter(item => item.branch === branchFilter);
                }
                
                if (statusFilter) {
                    filteredItems = filteredItems.filter(item => {
                        const stockPercentage = (item.quantity_base / item.max_stock_base) * 100;
                        const daysToExpiry = Math.ceil((new Date(item.expiry_date) - new Date()) / (1000 * 60 * 60 * 24));
                        
                        switch(statusFilter) {
                            case 'low':
                                return stockPercentage < this.settings.lowStockThreshold;
                            case 'over':
                                return stockPercentage > this.settings.overstockAlert;
                            case 'expiry':
                                return daysToExpiry <= this.settings.expiryWarningDays && daysToExpiry > 0;
                            case 'expired':
                                return daysToExpiry <= 0;
                            case 'stockout':
                                return item.quantity_base <= 0;
                            case 'negative':
                                return (item.selling_price_per_display - item.purchase_price_per_display) < 0;
                            default:
                                return true;
                        }
                    });
                }
                
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = '';
                
                if (filteredItems.length === 0) {
                    document.getElementById('noData').style.display = 'block';
                    return;
                }
                
                document.getElementById('noData').style.display = 'none';
                
                filteredItems.forEach(item => {
                    const displayQuantity = item.quantity_base / item.display_to_base_factor;
                    const registeredQuantity = Math.floor(item.quantity_base / item.registered_to_base_factor);
                    const remainingBase = item.quantity_base % item.registered_to_base_factor;
                    
                    const mixedUnit = `${registeredQuantity} ${item.registered_unit} + ${remainingBase} ${item.base_unit}`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${item.base_unit}</td>
                        <td>${item.registered_unit}</td>
                        <td>${item.registered_to_base_factor}</td>
                        <td>${item.display_unit}</td>
                        <td>${item.display_to_base_factor}</td>
                        <td>${item.quantity_base.toFixed(2)}</td>
                        <td>${displayQuantity.toFixed(2)}</td>
                        <td>${mixedUnit}</td>
                        <td>${item.min_stock_base} / ${item.max_stock_base}</td>
                        <td>ETB ${item.purchase_price_per_display.toFixed(2)}</td>
                        <td>ETB ${item.selling_price_per_display.toFixed(2)}</td>
                        <td>${item.markup.toFixed(1)}%</td>
                        <td>ETB ${(item.quantity_base * (item.purchase_price_per_display / item.display_to_base_factor)).toFixed(2)}</td>
                        <td>${item.batch_number}</td>
                        <td>${item.branch}</td>
                        <td>${new Date(item.expiry_date).toLocaleDateString()}</td>
                        <td>${item.allow_fractional_display ? 'Yes' : 'No'}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        this.editItem(itemId);
                    });
                });
                
                document.querySelectorAll('.delete-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        this.deleteItem(itemId);
                    });
                });
            }
            
            async editItem(itemId) {
                const item = this.stockItems.find(i => i.id === itemId);
                if (!item) return;
                
                this.isEditing = true;
                this.editingId = itemId;
                
                // Populate form
                document.getElementById('itemName').value = item.name;
                document.getElementById('category').value = item.category;
                document.getElementById('baseUnit').value = item.base_unit;
                document.getElementById('registeredUnit').value = item.registered_unit;
                document.getElementById('registeredToBaseFactor').value = item.registered_to_base_factor;
                document.getElementById('displayUnit').value = item.display_unit;
                document.getElementById('displayToBaseFactor').value = item.display_to_base_factor;
                document.getElementById('allowFractionalDisplay').value = item.allow_fractional_display ? 'true' : 'false';
                document.getElementById('purchasePricePerDisplay').value = item.purchase_price_per_display;
                document.getElementById('markup').value = item.markup;
                document.getElementById('sellingPricePerDisplay').value = item.selling_price_per_display;
                document.getElementById('batchNumber').value = item.batch_number;
                document.getElementById('expiryDate').value = item.expiry_date;
                document.getElementById('supplier').value = item.supplier;
                document.getElementById('registrant').value = item.registrant;
                document.getElementById('branch').value = item.branch;
                document.getElementById('storageLocation').value = item.storage_location || '';
                document.getElementById('minStockBase').value = item.min_stock_base;
                document.getElementById('maxStockBase').value = item.max_stock_base;
                
                // Open register stock page
                this.openPage('registerStockPage');
                
                this.showToast('Editing item: ' + item.name, 'info');
            }
            
            async deleteItem(itemId) {
                if (!confirm('Are you sure you want to delete this item?')) return;
                
                try {
                    const { error } = await supabase
                        .from('stock_items')
                        .delete()
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    // Remove from local array
                    const index = this.stockItems.findIndex(i => i.id === itemId);
                    if (index !== -1) {
                        const deletedItem = this.stockItems[index];
                        this.stockItems.splice(index, 1);
                        
                        // Record audit
                        this.recordAudit('delete', itemId, deletedItem.name, 0, 
                                       'item_deleted', deletedItem.branch, this.currentUserType || 'System');
                        
                        this.showToast('Item deleted successfully', 'success');
                        this.renderTable();
                    }
                } catch (error) {
                    console.error('Error deleting item:', error);
                    this.showToast('Error deleting item: ' + error.message, 'danger');
                }
            }
            
            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('branchFilter').value = '';
                document.getElementById('statusFilter').value = '';
                this.renderTable();
            }
            
            setupRealTimeCalculations() {
                // Conversion factor calculations
                const registeredFactor = document.getElementById('registeredToBaseFactor');
                const displayFactor = document.getElementById('displayToBaseFactor');
                const initialQuantity = document.getElementById('initialQuantity');
                const quantityType = document.getElementById('initialQuantityType');
                
                const updateConversions = () => {
                    const regFactor = parseFloat(registeredFactor.value) || 1;
                    const dispFactor = parseFloat(displayFactor.value) || 1;
                    const qty = parseFloat(initialQuantity.value) || 0;
                    const qtyType = quantityType.value;
                    
                    // Update conversion displays
                    document.getElementById('registeredConversionDisplay').textContent = 
                        `1 registered unit = ${regFactor} base units`;
                    document.getElementById('displayConversionDisplay').textContent = 
                        `1 display unit = ${dispFactor} base units`;
                    
                    // Calculate base quantity
                    let baseQty = 0;
                    switch(qtyType) {
                        case 'registered':
                            baseQty = qty * regFactor;
                            document.getElementById('quantityConversionDisplay').textContent = 
                                `${qty} registered units = ${baseQty} base units`;
                            break;
                        case 'display':
                            baseQty = qty * dispFactor;
                            document.getElementById('quantityConversionDisplay').textContent = 
                                `${qty} display units = ${baseQty} base units`;
                            break;
                        case 'base':
                            baseQty = qty;
                            document.getElementById('quantityConversionDisplay').textContent = 
                                `${qty} base units`;
                            break;
                        default:
                            document.getElementById('quantityConversionDisplay').textContent = 
                                'Enter quantity in selected units';
                    }
                    
                    // Update base quantity display
                    document.getElementById('baseQuantityDisplay').textContent = 
                        `${baseQty} base units`;
                    
                    // Update mixed unit display
                    if (regFactor > 0) {
                        const registeredUnits = Math.floor(baseQty / regFactor);
                        const remainingBase = baseQty % regFactor;
                        document.getElementById('mixedUnitDisplay').textContent = 
                            `${registeredUnits} ${document.getElementById('registeredUnit').value || 'registered'} + ${remainingBase} base units`;
                    }
                    
                    // Update total value
                    const purchasePrice = parseFloat(document.getElementById('purchasePricePerDisplay').value) || 0;
                    const totalValue = baseQty * (purchasePrice / dispFactor);
                    document.getElementById('totalValueCalc').textContent = 
                        `ETB ${totalValue.toFixed(2)} (${baseQty} base units)`;
                };
                
                registeredFactor.addEventListener('input', updateConversions);
                displayFactor.addEventListener('input', updateConversions);
                initialQuantity.addEventListener('input', updateConversions);
                quantityType.addEventListener('change', updateConversions);
                document.getElementById('purchasePricePerDisplay').addEventListener('input', updateConversions);
            }
            
            applyMarkup() {
                const purchasePrice = parseFloat(document.getElementById('purchasePricePerDisplay').value) || 0;
                const markup = parseFloat(document.getElementById('markup').value) || 0;
                const sellingPrice = purchasePrice * (1 + (markup / 100));
                
                document.getElementById('sellingPricePerDisplay').value = sellingPrice.toFixed(2);
                document.getElementById('sellingPriceDisplay').textContent = 
                    `ETB ${sellingPrice.toFixed(2)} (${markup}% markup)`;
            }
            
            setupAllClickableElements() {
                document.querySelectorAll('.page-link').forEach(element => {
                    element.addEventListener('click', (e) => {
                        const pageId = e.currentTarget.dataset.page;
                        const filter = e.currentTarget.dataset.filter;
                        
                        if (pageId) {
                            this.openPage(pageId);
                            
                            // Apply filter if specified
                            if (filter && document.getElementById('statusFilter')) {
                                document.getElementById('statusFilter').value = filter;
                                setTimeout(() => this.renderTable(), 100);
                            }
                        }
                    });
                });
            }
            
            updateReviewDashboard() {
                // Calculate metrics
                const totalItems = this.stockItems.length;
                const today = new Date().toISOString().split('T')[0];
                
                // Today's sales
                const todaySales = this.salesData
                    .filter(sale => sale.date === today)
                    .reduce((sum, sale) => sum + sale.grand_total, 0);
                
                // This month's sales
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthSales = this.salesData
                    .filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, sale) => sum + sale.grand_total, 0);
                
                // Low stock items
                const lowStockItems = this.stockItems.filter(item => 
                    (item.quantity_base / item.max_stock_base) * 100 < this.settings.lowStockThreshold
                ).length;
                
                // Near expiry items
                const nearExpiryItems = this.stockItems.filter(item => {
                    const daysToExpiry = Math.ceil((new Date(item.expiry_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysToExpiry <= this.settings.expiryWarningDays && daysToExpiry > 0;
                }).length;
                
                // Expired items
                const expiredItems = this.stockItems.filter(item => 
                    new Date(item.expiry_date) < new Date()
                ).length;
                
                // Stock out items
                const stockoutItems = this.stockItems.filter(item => 
                    item.quantity_base <= 0
                ).length;
                
                // Total inventory value
                const totalInventoryValue = this.stockItems.reduce((sum, item) => {
                    return sum + (item.quantity_base * (item.purchase_price_per_display / item.display_to_base_factor));
                }, 0);
                
                // Update dashboard values
                document.getElementById('totalStockItems').textContent = totalItems;
                document.getElementById('todaySales').textContent = `ETB ${todaySales.toFixed(2)}`;
                document.getElementById('totalSales').textContent = `ETB ${monthSales.toFixed(2)}`;
                document.getElementById('lowStockItems').textContent = lowStockItems;
                document.getElementById('nearExpiryItems').textContent = nearExpiryItems;
                document.getElementById('expiredItems').textContent = expiredItems;
                document.getElementById('stockoutItems').textContent = stockoutItems;
                document.getElementById('totalInventoryValue').textContent = `ETB ${totalInventoryValue.toFixed(2)}`;
                
                // Update charts
                this.updateCharts();
            }
            
            updateCharts() {
                // Branch distribution chart
                const branchData = {};
                this.stockItems.forEach(item => {
                    branchData[item.branch] = (branchData[item.branch] || 0) + 1;
                });
                
                const branchCtx = document.getElementById('branchChart').getContext('2d');
                new Chart(branchCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(branchData),
                        datasets: [{
                            data: Object.values(branchData),
                            backgroundColor: ['#ffd700', '#3a7bd5', '#00ff88']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Category chart
                const categoryData = {};
                this.stockItems.forEach(item => {
                    categoryData[item.category] = (categoryData[item.category] || 0) + 1;
                });
                
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                new Chart(categoryCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(categoryData).slice(0, 10), // Top 10 categories
                        datasets: [{
                            label: 'Item Count',
                            data: Object.values(categoryData).slice(0, 10),
                            backgroundColor: '#3a7bd5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            updateAuditSummary() {
                // Calculate audit summary values
                const beginningBalance = this.stockItems.reduce((sum, item) => {
                    return sum + (item.quantity_base * (item.purchase_price_per_display / item.display_to_base_factor));
                }, 0);
                
                const purchases = this.transactions
                    .filter(t => t.type === 'addition')
                    .reduce((sum, t) => sum + t.total_value, 0);
                
                const sales = this.salesData
                    .reduce((sum, sale) => sum + sale.grand_total, 0);
                
                const cogs = this.salesData
                    .reduce((sum, sale) => sum + sale.cogs, 0);
                
                const grossProfit = this.salesData
                    .reduce((sum, sale) => sum + sale.gross_profit, 0);
                
                // Update audit summary values
                document.getElementById('auditBeginningBalance').textContent = `ETB ${beginningBalance.toFixed(2)}`;
                document.getElementById('auditPurchases').textContent = `ETB ${purchases.toFixed(2)}`;
                document.getElementById('auditSales').textContent = `ETB ${sales.toFixed(2)}`;
                document.getElementById('auditCOGS').textContent = `ETB ${cogs.toFixed(2)}`;
                document.getElementById('auditGrossProfit').textContent = `ETB ${grossProfit.toFixed(2)}`;
                
                // Update alerts
                this.updateAuditAlerts();
            }
            
            updateAuditAlerts() {
                const alertsContainer = document.getElementById('auditAlerts');
                alertsContainer.innerHTML = '';
                
                // Check for low stock alerts
                const lowStockItems = this.stockItems.filter(item => 
                    (item.quantity_base / item.max_stock_base) * 100 < this.settings.lowStockThreshold
                );
                
                if (lowStockItems.length > 0 && this.settings.notifyLowStock) {
                    const alert = document.createElement('div');
                    alert.className = 'audit-warning';
                    alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${lowStockItems.length} items are below low stock threshold`;
                    alertsContainer.appendChild(alert);
                }
                
                // Check for expiry alerts
                const nearExpiryItems = this.stockItems.filter(item => {
                    const daysToExpiry = Math.ceil((new Date(item.expiry_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysToExpiry <= this.settings.expiryWarningDays && daysToExpiry > 0;
                });
                
                if (nearExpiryItems.length > 0 && this.settings.notifyExpiry) {
                    const alert = document.createElement('div');
                    alert.className = 'audit-alert';
                    alert.innerHTML = `<i class="fas fa-calendar-times"></i> ${nearExpiryItems.length} items are near expiry`;
                    alertsContainer.appendChild(alert);
                }
                
                // Check for negative profit items
                const negativeProfitItems = this.stockItems.filter(item => 
                    (item.selling_price_per_display - item.purchase_price_per_display) < 0
                );
                
                if (negativeProfitItems.length > 0 && this.settings.notifyNegativeProfit) {
                    const alert = document.createElement('div');
                    alert.className = 'audit-alert';
                    alert.innerHTML = `<i class="fas fa-money-bill-wave"></i> ${negativeProfitItems.length} items have negative profit margin`;
                    alertsContainer.appendChild(alert);
                }
                
                if (alertsContainer.children.length === 0) {
                    const info = document.createElement('div');
                    info.className = 'audit-info';
                    info.innerHTML = `<i class="fas fa-check-circle"></i> No critical alerts at this time`;
                    alertsContainer.appendChild(info);
                }
            }
            
            runAuditReport() {
                const startDate = document.getElementById('auditStartDate').value;
                const endDate = document.getElementById('auditEndDate').value;
                const userFilter = document.getElementById('auditUser').value;
                const branchFilter = document.getElementById('auditBranch').value;
                const typeFilter = document.getElementById('auditTypeFilter').value;
                
                let filteredAudits = this.auditTrail;
                
                if (startDate) {
                    filteredAudits = filteredAudits.filter(audit => audit.date >= startDate);
                }
                
                if (endDate) {
                    filteredAudits = filteredAudits.filter(audit => audit.date <= endDate);
                }
                
                if (userFilter) {
                    filteredAudits = filteredAudits.filter(audit => 
                        audit.user.toLowerCase().includes(userFilter.toLowerCase())
                    );
                }
                
                if (branchFilter) {
                    filteredAudits = filteredAudits.filter(audit => audit.branch === branchFilter);
                }
                
                if (typeFilter) {
                    filteredAudits = filteredAudits.filter(audit => audit.event_type === typeFilter);
                }
                
                // Sort by date (newest first)
                filteredAudits.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Update audit table
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = '';
                
                filteredAudits.forEach(audit => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(audit.created_at).toLocaleString()}</td>
                        <td>${audit.event_type}</td>
                        <td>${audit.item_name}</td>
                        <td>${audit.user}</td>
                        <td>${audit.quantity}</td>
                        <td>ETB ${(audit.quantity * (audit.details?.unitPrice || 0)).toFixed(2)}</td>
                        <td>${audit.branch}</td>
                        <td>${JSON.stringify(audit.details).substring(0, 50)}...</td>
                        <td>${audit.approval_status}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            async saveSystemSettings() {
                try {
                    const settings = {
                        lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value) || 20,
                        expiryWarningDays: parseInt(document.getElementById('expiryWarningDays').value) || 60,
                        defaultMarkup: parseFloat(document.getElementById('defaultMarkup').value) || 50.0,
                        defaultVAT: parseFloat(document.getElementById('defaultVAT').value) || 15.0,
                        overstockAlert: parseInt(document.getElementById('overstockAlert').value) || 150,
                        profitMarginAlert: parseInt(document.getElementById('profitMarginAlert').value) || 10,
                        notifyLowStock: document.getElementById('notifyLowStock').checked,
                        notifyExpiry: document.getElementById('notifyExpiry').checked,
                        notifyOverstock: document.getElementById('notifyOverstock').checked,
                        notifyNegativeProfit: document.getElementById('notifyNegativeProfit').checked,
                        autoCostCalc: document.getElementById('autoCostCalc').checked,
                        autoProfitCalc: document.getElementById('autoProfitCalc').checked,
                        autoMarginCalc: document.getElementById('autoMarginCalc').checked
                    };
                    
                    this.settings = settings;
                    
                    // Save to Supabase
                    await this.saveToSupabase('settings', {
                        key: 'pharmacy_settings',
                        value: settings,
                        updated_at: new Date().toISOString()
                    });
                    
                    this.showToast('Settings saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showToast('Error saving settings: ' + error.message, 'danger');
                }
            }
            
            exportToExcel() {
                try {
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Stock items sheet
                    const stockData = this.stockItems.map(item => ({
                        'Item Name': item.name,
                        'Category': item.category,
                        'Base Unit': item.base_unit,
                        'Registered Unit': item.registered_unit,
                        'Registered to Base Factor': item.registered_to_base_factor,
                        'Display Unit': item.display_unit,
                        'Display to Base Factor': item.display_to_base_factor,
                        'Quantity (Base)': item.quantity_base,
                        'Quantity (Display)': item.quantity_base / item.display_to_base_factor,
                        'Purchase Price/Display': item.purchase_price_per_display,
                        'Selling Price/Display': item.selling_price_per_display,
                        'Markup %': item.markup,
                        'Batch Number': item.batch_number,
                        'Expiry Date': new Date(item.expiry_date).toLocaleDateString(),
                        'Supplier': item.supplier,
                        'Branch': item.branch,
                        'Minimum Stock': item.min_stock_base,
                        'Maximum Stock': item.max_stock_base,
                        'Last Updated': new Date(item.updated_at).toLocaleString()
                    }));
                    
                    const wsStock = XLSX.utils.json_to_sheet(stockData);
                    XLSX.utils.book_append_sheet(wb, wsStock, 'Stock Items');
                    
                    // Sales data sheet
                    const salesData = this.salesData.map(sale => ({
                        'Invoice Number': sale.invoice_number,
                        'Date': sale.date,
                        'Branch': sale.branch,
                        'Payment Method': sale.payment_method,
                        'Salesperson': sale.salesperson,
                        'Approver': sale.approver,
                        'Subtotal': sale.subtotal,
                        'Discount': sale.discount,
                        'VAT': sale.vat,
                        'Grand Total': sale.grand_total,
                        'COGS': sale.cogs,
                        'Gross Profit': sale.gross_profit,
                        'Profit Margin %': sale.profit_margin,
                        'Items Count': sale.items.length,
                        'Created At': new Date(sale.created_at).toLocaleString()
                    }));
                    
                    const wsSales = XLSX.utils.json_to_sheet(salesData);
                    XLSX.utils.book_append_sheet(wb, wsSales, 'Sales');
                    
                    // Generate Excel file
                    XLSX.writeFile(wb, `Pharmacy_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    this.showToast('Excel export completed!', 'success');
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    this.showToast('Error exporting to Excel: ' + error.message, 'danger');
                }
            }
            
            populateAddStockItems() {
                const select = document.getElementById('addItemSelect');
                select.innerHTML = '<option value="">Choose an item...</option>';
                
                this.stockItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${item.branch} - ${item.quantity_base} ${item.base_unit})`;
                    select.appendChild(option);
                });
                
                // Add change listener
                select.addEventListener('change', () => {
                    const itemId = select.value;
                    const item = this.stockItems.find(i => i.id === itemId);
                    
                    if (item) {
                        document.getElementById('addBaseUnit').value = item.base_unit;
                        document.getElementById('addRegisteredUnit').value = item.registered_unit;
                        document.getElementById('addRegisteredToBaseFactor').value = item.registered_to_base_factor;
                        document.getElementById('addDisplayUnit').value = item.display_unit;
                        document.getElementById('addDisplayToBaseFactor').value = item.display_to_base_factor;
                        document.getElementById('addAllowFractional').value = item.allow_fractional_display ? 'Yes' : 'No';
                        document.getElementById('addUnitPrice').value = item.purchase_price_per_display;
                        document.getElementById('addMarkup').value = item.markup;
                        document.getElementById('addSellingPrice').value = item.selling_price_per_display;
                        document.getElementById('addBranch').value = item.branch;
                        
                        // Update conversion displays
                        document.getElementById('addRegisteredConversionDisplay').textContent = 
                            `1 ${item.registered_unit} = ${item.registered_to_base_factor} ${item.base_unit}`;
                        document.getElementById('addDisplayConversionDisplay').textContent = 
                            `1 ${item.display_unit} = ${item.display_to_base_factor} ${item.base_unit}`;
                    }
                });
            }
            
            populateDeductStockItems() {
                const select = document.getElementById('reduceItemSelect');
                select.innerHTML = '<option value="">Choose an item...</option>';
                
                this.stockItems.forEach(item => {
                    if (item.quantity_base > 0) {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.name} (${item.branch} - Available: ${item.quantity_base / item.display_to_base_factor} ${item.display_unit})`;
                        select.appendChild(option);
                    }
                });
                
                // Add change listener
                select.addEventListener('change', () => {
                    const itemId = select.value;
                    const item = this.stockItems.find(i => i.id === itemId);
                    
                    if (item) {
                        document.getElementById('reduceBaseUnit').value = item.base_unit;
                        document.getElementById('reduceDisplayUnit').value = item.display_unit;
                        document.getElementById('reduceDisplayToBaseFactor').value = item.display_to_base_factor;
                        document.getElementById('reduceBranch').value = item.branch;
                        
                        // Update available quantities
                        const availableDisplay = item.quantity_base / item.display_to_base_factor;
                        document.getElementById('availableDisplayQuantity').textContent = availableDisplay.toFixed(2);
                        document.getElementById('availableBaseQuantity').textContent = item.quantity_base.toFixed(2);
                        
                        // Update conversion display
                        document.getElementById('reduceConversionDisplay').textContent = 
                            `1 ${item.display_unit} = ${item.display_to_base_factor} ${item.base_unit}`;
                    }
                });
                
                // Add quantity change listener
                document.getElementById('reduceQuantity').addEventListener('input', () => {
                    const itemId = document.getElementById('reduceItemSelect').value;
                    const item = this.stockItems.find(i => i.id === itemId);
                    
                    if (item) {
                        const quantity = parseFloat(document.getElementById('reduceQuantity').value) || 0;
                        const baseQuantity = quantity * item.display_to_base_factor;
                        document.getElementById('reduceBaseQuantity').textContent = baseQuantity.toFixed(2);
                    }
                });
            }
            
            async processAddStock() {
                try {
                    const itemId = document.getElementById('addItemSelect').value;
                    const quantityType = document.getElementById('addQuantityType').value;
                    const quantity = parseFloat(document.getElementById('addQuantity').value) || 0;
                    const branch = document.getElementById('addBranch').value;
                    const reason = document.getElementById('addReason').value;
                    
                    if (!itemId || !quantity || quantity <= 0) {
                        this.showToast('Please select item and enter valid quantity', 'warning');
                        return;
                    }
                    
                    const item = this.stockItems.find(i => i.id === itemId);
                    if (!item) {
                        this.showToast('Selected item not found', 'warning');
                        return;
                    }
                    
                    // Calculate base quantity
                    let baseQuantity = 0;
                    switch(quantityType) {
                        case 'registered':
                            baseQuantity = quantity * item.registered_to_base_factor;
                            break;
                        case 'display':
                            baseQuantity = quantity * item.display_to_base_factor;
                            break;
                        case 'base':
                            baseQuantity = quantity;
                            break;
                    }
                    
                    // Update stock quantity
                    item.quantity_base += baseQuantity;
                    item.updated_at = new Date().toISOString();
                    
                    // Update purchase price if provided
                    const newPurchasePrice = parseFloat(document.getElementById('addUnitPrice').value);
                    const newMarkup = parseFloat(document.getElementById('addMarkup').value);
                    const newSellingPrice = parseFloat(document.getElementById('addSellingPrice').value);
                    
                    if (newPurchasePrice > 0) {
                        item.purchase_price_per_display = newPurchasePrice;
                    }
                    
                    if (newMarkup > 0) {
                        item.markup = newMarkup;
                    }
                    
                    if (newSellingPrice > 0) {
                        item.selling_price_per_display = newSellingPrice;
                    }
                    
                    // Save to Supabase
                    await this.saveToSupabase('stock_items', item);
                    
                    // Record transaction and audit
                    this.recordTransaction('addition', item.id, item.name, baseQuantity, 
                                          reason, branch, item.purchase_price_per_display, 
                                          document.getElementById('addApprovedBy').value || 'System', 
                                          item.display_unit);
                    
                    this.recordAudit('add_stock', item.id, item.name, baseQuantity, 
                                   'stock_inflow', branch, 'System', {
                                       reason: reason,
                                       batch: document.getElementById('addBatchNumber').value || 'N/A',
                                       supplier: document.getElementById('addSupplier').value || 'N/A',
                                       notes: document.getElementById('addNotes').value || ''
                                   });
                    
                    // Send WebSocket update
                    this.sendWebSocketMessage({
                        type: 'stock_update',
                        data: item
                    });
                    
                    this.showToast(`Added ${baseQuantity} ${item.base_unit} to ${item.name}`, 'success');
                    
                    // Clear form
                    document.getElementById('addStockForm').reset();
                    
                } catch (error) {
                    console.error('Error adding stock:', error);
                    this.showToast('Error adding stock: ' + error.message, 'danger');
                }
            }
            
            async processDeductStock() {
                try {
                    const itemId = document.getElementById('reduceItemSelect').value;
                    const quantity = parseFloat(document.getElementById('reduceQuantity').value) || 0;
                    const branch = document.getElementById('reduceBranch').value;
                    const reason = document.getElementById('reduceReason').value;
                    const whom = document.getElementById('whom').value;
                    
                    if (!itemId || !quantity || quantity <= 0 || !whom) {
                        this.showToast('Please fill all required fields', 'warning');
                        return;
                    }
                    
                    const item = this.stockItems.find(i => i.id === itemId);
                    if (!item) {
                        this.showToast('Selected item not found', 'warning');
                        return;
                    }
                    
                    // Calculate base quantity
                    const baseQuantity = quantity * item.display_to_base_factor;
                    
                    // Check if enough stock is available
                    if (baseQuantity > item.quantity_base) {
                        this.showToast(`Insufficient stock. Available: ${item.quantity_base / item.display_to_base_factor} ${item.display_unit}`, 'warning');
                        return;
                    }
                    
                    // Update stock quantity
                    item.quantity_base -= baseQuantity;
                    item.updated_at = new Date().toISOString();
                    
                    // Save to Supabase
                    await this.saveToSupabase('stock_items', item);
                    
                    // Record transaction and audit
                    this.recordTransaction('deduction', item.id, item.name, baseQuantity, 
                                          reason, branch, 0, whom, item.display_unit);
                    
                    this.recordAudit('deduct_stock', item.id, item.name, baseQuantity, 
                                   'stock_outflow', branch, whom, {
                                       reason: reason,
                                       approver: document.getElementById('approver').value || 'N/A',
                                       notes: document.getElementById('reduceNotes').value || ''
                                   });
                    
                    // Send WebSocket update
                    this.sendWebSocketMessage({
                        type: 'stock_update',
                        data: item
                    });
                    
                    this.showToast(`Deducted ${baseQuantity} ${item.base_unit} from ${item.name}`, 'success');
                    
                    // Clear form
                    document.getElementById('reduceStockForm').reset();
                    
                } catch (error) {
                    console.error('Error deducting stock:', error);
                    this.showToast('Error deducting stock: ' + error.message, 'danger');
                }
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.stockSystem = new StockSystem();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl + S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const activePage = document.querySelector('.full-screen-mode.active');
                    if (activePage && activePage.id === 'registerStockPage') {
                        document.getElementById('saveBtn').click();
                    }
                }
                
                // Escape to close modal
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.full-screen-mode.active, .guideline-modal.active');
                    if (activeModal) {
                        const closeBtn = activeModal.querySelector('.close-full-screen, .close-guideline');
                        if (closeBtn) closeBtn.click();
                    }
                }
            });
            
            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
        });
    </script>
</body>
</html>
